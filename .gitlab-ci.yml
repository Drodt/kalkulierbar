#defines stages
stages:
  - test
  - deploy

#Frontend: yarn build
yarn:
  stage: test
  image: node
  before_script:
    - cd frontend
  script:
    - yarn build
  after_script:
    - cd ..

#Backend: gradle build
gradle:
  stage: test
  image: gradle:jdk11
  before_script:
    - cd backend
  script:
    - gradle build --no-daemon
  after_script:
    - cd ..

deploy:
  type: deploy
  stage: deploy
  image: node
  before_script:
    - apt-get update -y
    - apt-get install ruby-dev -y
    - gem install dpl
    - cd frontend
  script:
    - dpl --provider=heroku --app=$HEROKU_APP_FRONTEND --api-key=$HEROKU_API_KEY
  after_script:
    - cd ..
  only:
    - tags

deploy-api:
  type: deploy
  stage: deploy
  image: gradle:jdk11
  before_script:
    - apt-get update -y
    - apt-get install ruby-dev -y
    - gem install dpl
    - cd backend
  script:
    - gradle build --no-daemon
    - dpl --provider=heroku --app=$HEROKU_APP_BACKEND --api-key=$HEROKU_API_KEY --skip-cleanup
  after_script:
    - cd ..
  only:
    - tags
